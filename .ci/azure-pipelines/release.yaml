# Release PCL steps:
# 1. Check tests:
#   * debian:latest
#   * perception_pcl
# 2. Package for
#   * MacOS
#   * tar source release
#   * Windows Installers

resources:
- repo: self

variables:
  dockerHub: "PersonalDockerHub"
  dockerHubID: "kunaltyagi"

stages:
- stage: Debian
  dependsOn: []
  jobs:
  - job: BuildDebian
    displayName: "Build Debian Latest"
    timeoutInMinutes: 360
    variables:
      tag: "release"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
      # find the commit hash on a quick non-forced update too
      fetchDepth: 10
    - task: Docker@2
      displayName: "Build docker image"
      inputs:
        command: build
        arguments: |
          --no-cache
          -t $(dockerHubID)/release:$(tag)
        dockerfile: '$(Build.SourcesDirectory)/.dev/docker/release/Dockerfile'
        tags: "$(tag)"
- stage: ROS
  dependsOn: []
  jobs:
  - job: PerceptionPCL
    displayName: "perception_pcl compile"
    timeoutInMinutes: 360
    pool:
      vmImage: 'ubuntu-latest'
    variables:
      tag: "ros"
    steps:
    - checkout: self
      # find the commit hash on a quick non-forced update too
      fetchDepth: 10
    - task: Docker@2
      displayName: "Build docker image"
      inputs:
        command: build
        arguments: |
          --no-cache
          -t $(dockerHubID)/release:$(tag)
        dockerfile: '$(Build.SourcesDirectory)/.dev/docker/perception_pcl_ros/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)/.dev/docker/perception_pcl_ros'
        tags: "$(tag)"
- stage: Source
  dependsOn: ["Debian", "ROS"]
  jobs:
  - job: src_code
    displayName: "Package Source Code"
    timeoutInMinutes: 360
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
      # find the commit hash on a quick non-forced update too
      fetchDepth: 10
    - task: Bash@3
      displayName: "Remove git files"
      inputs:
        targetType: 'inline'
        script: 'rm -fr ./.git'
        workingDirectory: '$(Build.SourcesDirectory)'
        failOnStderr: true
    - task: ArchiveFiles@2
      displayName: "Create release archive"
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)'
        includeRootFolder: true
        archiveType: 'tar'
        archiveFile: '$(Build.ArtifactStagingDirectory)/source.tar.gz'
        replaceExistingArchive: true
        verbose: true
    - task: PublishBuildArtifacts@1
      displayName: "Publish archive"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'source.tar.gz'
        publishLocation: 'Container'